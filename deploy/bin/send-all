#!/bin/bash

#
# This is a simple bash script to run the Underdog code with some
# arguments so that we can exercise it from the command line.
#

#
# In order to handle the some fo the networking code in Java, we
# need to have `ifconfig` in the PATH, but it's not typically in
# the default crontab PATH, so let's add it's location into the
# mix so we can be assured of picking it up properly.
#
export PATH="/usr/local/bin:/usr/local/sbin:/usr/sbin:/sbin:$HOME/bin:$PATH"
#
# In order to make sure that all the code has reasonable default
# encodings, we need to make sure that we specify the default language
# here. This is no big deal for login shells, but it's a major issue
# for cronjobs - where there is no default.
#
export LANG="en_US.UTF-8"

#
# We need to get the right environment from the machine name as that's
# the best indicator we have now.
#
case `hostname` in
	*.guaranteedrate.com)
		export POLARIS_ENV="prod"
		;;
	*.grarate.com)
		export POLARIS_ENV="jv"
		;;
	*.gr-dev.com)
		export POLARIS_ENV="dev"
		;;
esac

#
# Jump right in...
#
program=`basename $0`
dir=`dirname $0`
#
# Get the name of the ACTUAL jar file that we'll be running. This is a
# simple symlink, so we just need to "look through the link".
#
if [ -d target ]; then
	proj=`head -1 project.clj`
	project=`echo ${proj} | awk '{print $2}'`
	version=`echo ${proj} | awk '{print $3}' | tr -d '"'`
	jar="target/${project}-${version}-standalone.jar"
elif [ -f /home/newsroom/newsroom-current.jar ]; then
	jar=`readlink -f /home/newsroom/newsroom-current.jar`
fi
gc_opts="-XX:+UseConcMarkSweepGC -DPOLARIS_ENV=${POLARIS_ENV}"
cp="$jar"
java -Xmx2g $gc_opts -cp $cp newsroom.main reload "$@"
