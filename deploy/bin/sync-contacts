#!/bin/bash

#
# This is a simple bash script to run the Newsroom code with some
# arguments so that we can exercise it from the command line.
#

#
# In order to handle the some fo the networking code in Java, we
# need to have `ifconfig` in the PATH, but it's not typically in
# the default crontab PATH, so let's add it's location into the
# mix so we can be assured of picking it up properly.
#
export PATH="/usr/local/bin:/usr/local/sbin:/usr/sbin:/sbin:$HOME/bin:$PATH"
#
# In order to make sure that all the code has reasonable default
# encodings, we need to make sure that we specify the default language
# here. This is no big deal for login shells, but it's a major issue
# for cronjobs - where there is no default.
#
export LANG="en_US.UTF-8"

#
# We need to get the right environment from the machine name as that's
# the best indicator we have now.
#
ep=''
auth='Authorization: ns-toolkit 31fc3437-004a-4402-b3b6-e96d58d1c508'
case `hostname` in
	*.guaranteedrate.com)
		export POLARIS_ENV="prod"
		ep='https://dipper.guaranteedrate.com/v1/contacts/sync'
		;;
	*.grarate.com)
		export POLARIS_ENV="jv"
		ep='https://dipper.grarate.com/v1/contacts/sync'
		;;
	*.gr-dev.com)
		export POLARIS_ENV="dev"
		ep='https://dipper.gr-dev.com/v1/contacts/sync'
		;;
esac

#
# Jump right in...
#
program=`basename $0`
dir=`dirname $0`
#
# If we have been asked to do this 'async', then that means we have to
# hit the service and tell *it* to do the sync, as opposed to us running
# it in a new java process.
#
if [ "$1" = "async" ]; then
	#
	# Do this by hitting the endpoint and letting the service do it
	#
	resp=`curl -s ${ep} -X GET -H ${auth}`
	echo "Fired off the sync of all ${POLARIS_ENV} Contacts from Total Expert"
else
	#
	# Get the name of the ACTUAL jar file that we'll be running. This is a
	# simple symlink, so we just need to "look through the link".
	#
	if [ -f /home/newsroom/newsroom-current.jar ]; then
		jar=`readlink -f /home/newsroom/newsroom-current.jar`
	elif [ -d target ]; then
		proj=`head -1 project.clj`
		project=`echo ${proj} | awk '{print $2}'`
		version=`echo ${proj} | awk '{print $3}' | tr -d '"'`
		jar="target/${project}-${version}-standalone.jar"
	fi
	gc_opts="-XX:+UseConcMarkSweepGC -DPOLARIS_ENV=${POLARIS_ENV}"
	cp="$jar"
	java -Xmx1g $gc_opts -cp $cp newsroom.main -q sync-contacts "$@"
fi
exit 0
